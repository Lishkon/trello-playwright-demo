# azure-pipelines.yml

# Triggers
trigger:
  branches:
    include:
      - main

# Schedule for nightly builds (equivalent to GitLab scheduled pipelines)
schedules:
  - cron: "0 0 * * *"  # Midnight UTC daily
    displayName: "Nightly Build"
    branches:
      include:
        - main
    always: true

# Global variables
variables:
  PW_IMAGE: "mcr.microsoft.com/playwright:v1.53.2-jammy"
  # Default test suite (overridden for scheduled builds)
  TEST_SUITE: "tests/login.spec.ts"

# Define stages
stages:
  - stage: DetermineBuildType
    displayName: "Determine Build Type"
    jobs:
      - job: SetTestSuite
        displayName: "Set Test Suite Based on Build Reason"
        pool:
          name: "Default" # Setting up the default option to use the self-hosted agent. Replace this with `ubuntu-latest` when the hosted parallelism is enabled
        steps:
          - checkout: none
          - powershell: |
              Write-Host "===================================================================="
              Write-Host "Build Reason: $(Build.Reason)"
              if ("$(Build.Reason)" -eq "Schedule") {
                Write-Host "Build Type: NIGHTLY BUILD"
                Write-Host "Test Suite: Full regression (all tests)"
                Write-Host "##vso[task.setvariable variable=TEST_SUITE;isOutput=true]tests/"
              } else {
                Write-Host "Build Type: COMMIT-TRIGGERED BUILD"
                Write-Host "Test Suite: Smoke tests (login.spec.ts)"
                Write-Host "##vso[task.setvariable variable=TEST_SUITE;isOutput=true]tests/login.spec.ts"
              }
              Write-Host "===================================================================="
            displayName: "Determine Test Suite"
            name: buildType

  - stage: Test
    displayName: "Run Playwright Tests"
    dependsOn: DetermineBuildType
    variables:
      TEST_SUITE_RESOLVED: $[ stageDependencies.DetermineBuildType.SetTestSuite.outputs['buildType.TEST_SUITE'] ]
    jobs:
      - job: PlaywrightTests
        displayName: "Playwright Tests"
        pool:
          name: "Default" # Setting up the default option to use the self-hosted agent. Replace this with `ubuntu-latest` when the hosted parallelism is enabled
        steps:
          - checkout: self
            displayName: "Checkout Repository"

          - script: |
              echo "Test suite to run: $(TEST_SUITE_RESOLVED)"
            displayName: "Display Test Suite"

          - powershell: |
              docker run --name pw-tests `
                -e CI=1 `
                -e USER_EMAIL=$(E2E_VALID_USER) `
                -e USER_PASSWORD=$(E2E_VALID_PASS) `
                -e INVALID_USER_EMAIL=$(E2E_INVALID_USER) `
                -e INVALID_USER_PASSWORD=$(E2E_VALID_PASS) `
                -e TOTP_SECRET=$(TOTP_SECRET) `
                -v "$(Build.SourcesDirectory):/work" `
                $(PW_IMAGE) `
                bash -c "set -euxo pipefail && cd /work && npm install && CI=1 npx playwright test $(TEST_SUITE_RESOLVED) --reporter=html"
              if ($LASTEXITCODE -ne 0) {
                Write-Host "Tests completed with exit code $LASTEXITCODE"
              }
            displayName: "Run Playwright Tests in Docker"

          - powershell: |
              docker cp pw-tests:/work/playwright-report $(Build.ArtifactStagingDirectory)/playwright-report
              if (-not $?) { Write-Host "Failed to copy report" }
              Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)/playwright-report" -ErrorAction SilentlyContinue
            displayName: "Copy Test Report"
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: "Publish Playwright Report"
            condition: always()
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/playwright-report"
              artifact: "playwright-report"
              publishLocation: "pipeline"

  - stage: Publish
    displayName: "Publish Report"
    dependsOn: Test
    condition: and(always(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PublishReport
        displayName: "Publish HTML Report"
        pool:
          name: "Default" # Setting up the default option to use the self-hosted agent. Replace this with `ubuntu-latest` when the hosted parallelism is enabled
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: "Download Playwright Report"
            inputs:
              artifact: "playwright-report"
              path: "$(Build.ArtifactStagingDirectory)/playwright-report"

          - powershell: |
              New-Item -ItemType Directory -Force -Path "$(Build.ArtifactStagingDirectory)/public"
              Copy-Item -Path "$(Build.ArtifactStagingDirectory)/playwright-report/*" -Destination "$(Build.ArtifactStagingDirectory)/public/" -Recurse -ErrorAction SilentlyContinue
              if (-not $?) { Write-Host "No report found" }
            displayName: "Copy Report to Public Folder"

          - task: PublishPipelineArtifact@1
            displayName: "Publish Public Artifact"
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/public"
              artifact: "public"
              publishLocation: "pipeline"