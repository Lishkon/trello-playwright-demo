# azure-pipelines.yml

# Triggers
trigger:
  branches:
    include:
      - main

# Schedule for nightly builds (equivalent to GitLab scheduled pipelines)
schedules:
  - cron: "0 0 * * *"  # Midnight UTC daily
    displayName: "Nightly Build"
    branches:
      include:
        - main
    always: true

# Global variables
variables:
  PW_IMAGE: "mcr.microsoft.com/playwright:v1.53.2-jammy"
  # Default test suite (overridden for scheduled builds)
  TEST_SUITE: "tests/login.spec.ts"

# Define stages
stages:
  - stage: DetermineBuildType
    displayName: "Determine Build Type"
    jobs:
      - job: SetTestSuite
        displayName: "Set Test Suite Based on Build Reason"
        pool:
          name: "Default" # Setting up the default option to use the self-hosted agent. Replace this with `ubuntu-latest` when the hosted parallelism is enabled
        steps:
          - checkout: none
          - powershell: |
              Write-Host "===================================================================="
              Write-Host "Build Reason: $(Build.Reason)"
              if ("$(Build.Reason)" -eq "Schedule") {
                Write-Host "Build Type: NIGHTLY BUILD"
                Write-Host "Test Suite: Full regression (all tests)"
                Write-Host "##vso[task.setvariable variable=TEST_SUITE;isOutput=true]tests/"
              } else {
                Write-Host "Build Type: COMMIT-TRIGGERED BUILD"
                Write-Host "Test Suite: Smoke tests (login.spec.ts)"
                Write-Host "##vso[task.setvariable variable=TEST_SUITE;isOutput=true]tests/login.spec.ts"
              }
              Write-Host "===================================================================="
            displayName: "Determine Test Suite"
            name: buildType

  - stage: Test
    displayName: "Run Playwright Tests"
    variables:
      TEST_SUITE_RESOLVED: $[ stageDependencies.DetermineBuildType.SetTestSuite.outputs['buildType.TEST_SUITE'] ]
    jobs:
      - job: PlaywrightTests
        displayName: "Playwright Tests"
        pool:
          name: "Default" # Setting up the default option to use the self-hosted agent. Replace this with `ubuntu-latest` when the hosted parallelism is enabled
        steps:
          - powershell: |
              $workDir = "$(Build.SourcesDirectory)"
              if (Test-Path "$workDir\test-results") {
                Write-Host "Cleaning up test-results folder..."
                Remove-Item -Path "$workDir\test-results" -Recurse -Force -ErrorAction SilentlyContinue
              }
              if (Test-Path "$workDir\playwright-report") {
                Write-Host "Cleaning up playwright-report folder..."
                Remove-Item -Path "$workDir\playwright-report" -Recurse -Force -ErrorAction SilentlyContinue
              }
            displayName: "Clean Previous Test Artifacts"
            condition: always()

          - checkout: self 
            displayName: "Checkout Repository"
            clean: false #Don't let git clean, we handle it ourselves
          
          - task: NodeTool@0
            displayName: "Install Noed.js"
            inputs:
              versionSpec: "18.x"

          - powershell: |
              Write-Host "Test suite to run: $(TEST_SUITE_RESOLVED)"
            displayName: "Display Test Suite"

          - powershell: |
              npm ci
            displayName: "Install Dependencies"

          - powershell: |
              npx playwright install --with-deps chromium
            displayName: "Install Playwright Browsers"



          - powershell: |
              $env:CI = "1"
              $env:USER_EMAIL = $env:E2E_VALID_USER
              $env:USER_PASSWORD = $env:E2E_VALID_PASS
              $env:INVALID_USER_EMAIL = $env:E2E_INVALID_USER
              $env:INVALID_USER_PASSWORD = $env:E2E_VALID_PASS
              
              $testSuite = "$(TEST_SUITE_RESOLVED)"
              Write-Host "Running tests: $testSuite"
              
              npx playwright test $testSuite --reporter=html
            displayName: "Run Playwright Tests"
            env:
              E2E_VALID_USER: ${E2E_VALID_USER}
              E2E_VALID_PASS: ${E2E_VALID_PASS}
              E2E_INVALID_USER: ${E2E_INVALID_USER}
              TOTP_SECRET: ${TOTP_SECRET}
          - task: PublishPipelineArtifact@1
            displayName: "Publish Playwright Report"
            condition: always()
            inputs:
              targetPath: "playwright-report"
              artifact: "playwright-report"
              publishLocation: "pipeline"
          
  - stage: Publish
    displayName: "Publish Report"
    dependsOn: Test
    condition: and(always(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PublishReport
        displayName: "Publish HTML Report"
        pool:
          name: "Default"
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: "Download Playwright Report"
            inputs:
              artifact: "playwright-report"
              path: "$(Build.ArtifactStagingDirectory)/playwright-report"
          
          - powershell: |
              $artifactDir = $env:BUILD_ARTIFACTSTAGINGDIRECTORY
              New-Item -ItemType Directory -Force -Path "$artifactDir/public"
              Copy-Item -Path "$artifactDir/playwright-report/*" -Destination "$artifactDir/public/" -Recurse -ErrorAction SilentlyContinue
              if (-not $?) { Write-Host "No report found" }
            displayName: "Copy Report to Public Folder"
            env:
              BUILD_ARTIFACTSTAGINGDIRECTORY: $(Build.ArtifactStagingDirectory)
          
          - task: PublishPipelineArtifact@1
            displayName: "Publish Public Artifact"
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/public"
              artifact: "public"
              publishLocation: "pipeline"
