# .gitlab-ci.yml

# Global variables
variables:
  PW_IMAGE: "mcr.microsoft.com/playwright:v1.53.2-jammy"
  # Determine test suite based on pipeline source
  # Using login tests currently as an example to save timegi
  TEST_SUITE: "tests/login.spec.ts"

# Define stages
stages:
  - determine-build-type
  - test
  - publish

# Determine what type of build this is
determine-build-type:
  stage: determine-build-type
  image: alpine:latest
  script:
    - |
      echo "===================================================================="
      if [ "$CI_PIPELINE_SOURCE" = "schedule" ]; then
        echo "Build Type: NIGHTLY BUILD"
        echo "Test Suite: Full regression (all tests)"
        echo "TEST_SUITE=tests/" >> build.env
      else
        echo "Build Type: COMMIT-TRIGGERED BUILD"
        echo "Test Suite: Smoke tests (login.spec.ts)"
        echo "TEST_SUITE=tests/login.spec.ts" >> build.env
      fi
      echo "===================================================================="
  artifacts:
    reports:
      dotenv: build.env

# Run Playwright tests
playwright-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.53.2-jammy
  dependencies:
    - determine-build-type
  variables:
    USER_EMAIL: ${E2E_VALID_USER}
    USER_PASSWORD: ${E2E_VALID_PASS}
    INVALID_USER_EMAIL: ${E2E_INVALID_USER}
    INVALID_USER_PASSWORD: ${E2E_INVALID_PASS}
    TOTP_SECRET: ${TOTP_SECRET}
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  before_script:
    - echo "Test suite to run $TEST_SUITE"
    - npm ci
  script:
    - npx playwright test $TEST_SUITE
  artifacts:
    when: always
    paths:
      - reports/
    reports:
      junit: reports/junit/results.xml
    expire_in: 30 days
  allow_failure: false

# Publish the playwright reports
pages:
  stage: publish
  image: alpine:latest
  dependencies:
    - playwright-tests
  script:
    - mkdir -p public
    - cp -r reports/playwright/* public/ || echo "No report found"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"  # Only for main branch
  when: always


workflow:
    rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

    