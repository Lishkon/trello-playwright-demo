# .gitlab-ci.yml

# Global variables
variables:
  PW_IMAGE: "mcr.microsoft.com/playwright:v1.53.2-jammy"
  TEST_SUITE: "tests/"

# Define stages
stages:
  - test
  - publish

# Run Playwright tests
playwright-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.53.2-jammy
  variables:
    USER_EMAIL: ${E2E_VALID_USER}
    USER_PASSWORD: ${E2E_VALID_PASS}
    INVALID_USER_EMAIL: ${E2E_INVALID_USER}
    INVALID_USER_PASSWORD: ${E2E_INVALID_PASS}
    TOTP_SECRET: ${TOTP_SECRET}
    TRELLO_API_KEY: ${TRELLO_API_KEY}
    TRELLO_API_TOKEN: ${TRELLO_API_TOKEN}
  dependencies:
    - determine-build-type
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  before_script:
    - echo "Test suite to run $TEST_SUITE"
    - npm ci
  script:
    - npx playwright test $TEST_SUITE
  artifacts:
    when: always
    paths:
      - reports/
    reports:
      junit: reports/junit/results.xml
    expire_in: 30 days
  allow_failure: false

# Publish the playwright reports
pages:
  stage: publish
  image: alpine:3.21
  dependencies:
    - playwright-tests
  script:
    - mkdir -p public
    - cp -r reports/playwright/* public/ || echo "No report found"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"  # Only for main branch
  when: always


workflow:
    rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

    