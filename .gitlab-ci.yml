# .gitlab-ci.yml

# Global variables
variables:
  PW_IMAGE: "mcr.microsoft.com/playwright:v1.53.2-jammy"
  # Determine test suite based on pipeline source
  # Using login tests currently as an example to save timegi
  TEST_SUITE: "tests/login.spec.ts"

# Define stages
stages:
  - determine-build-type
  - test
  - publish

# Determine what type of build this is
determine-build-type:
  stage: determine-build-type
  image: alpine:latest
  script:
    - |
      echo "===================================================================="
      if [ "$CI_PIPELINE_SOURCE" = "schedule" ]; then
        echo "Build Type: NIGHTLY BUILD"
        echo "Test Suite: Full regression (all tests)"
        echo "TEST_SUITE=tests/" >> build.env
      else
        echo "Build Type: COMMIT-TRIGGERED BUILD"
        echo "Test Suite: Smoke tests (login.spec.ts)"
        echo "TEST_SUITE=tests/login.spec.ts" >> build.env
      fi
      echo "===================================================================="
  artifacts:
    reports:
      dotenv: build.env

# Run Playwright tests
playwright-tests:
  stage: test
  image: docker:latest
  services:
    - docker:dind 
  dependencies:
    - determine-build-type
  before_script:
    - echo "Test suite to run $TEST_SUITE"
  script:
    - |
      docker run --name pw-tests \
        -e CI=1 \
        -e USER_EMAIL=${E2E_VALID_USER} \
        -e USER_PASSWORD=${E2E_VALID_PASS} \
        -e INVALID_USER_EMAIL=${E2E_INVALID_USER} \
        -e INVALID_USER_PASSWORD=${E2E_VALID_PASS} \
        -e TOTP_SECRET=${TOTP_SECRET} \
        ${PW_IMAGE} \
        bash -c "
          set -euxo pipefail
          apt-get update && apt-get install -y git
          git clone --branch main --single-branch ${CI_REPOSITORY_URL} /work
          cd /work
          npm install
          CI=1 npx playwright test ${TEST_SUITE} --reporter=html
        " || echo "Tests completed with exit code $?"
  after_script:
    - docker cp pw-tests:/work/playwright-report ./playwright-report || Echo "Failed to copy report"
    - ls -la playwright-report/ || echo "No report directory"
    - docker rm -f pw-tests || true
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 30 days
  allow_failure: false

# Publish the playwright reports
publish-report:
  stage: publish
  image: alpine:latest
  dependencies:
    - playwright-tests
  script:
    - mkdir -p public
    - cp -r playwright-report/* public/ || echo "No report found"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"  # Only for main branch
  when: always


workflow:
    rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

    